## ssh登陆原理以及端口转发

### 简介：
SSH，全名secure shell，其目的是用来从终端与远程机器交互，SSH设计之处初，遵循了如下原则：

  * 机器之间通讯的内容必须经过加密。
  * 加密过程中，通过 public key加密，private 解密。

### 密钥:
SSH通讯的双方各自持有一个公钥私钥对，公钥对对方是可见的，私钥仅持有者可见，你可以通过"ssh-keygen"生成自己的公私钥，默认情况下，公私钥的存放路径如下：    

  * 公钥：$HOME/.ssh/id_rsa.pub
  * 私钥：$HOME/.ssh/id_rsa

### 基于口令的安全验证通讯原理：

  建立通信通道的步骤如下：

```
  1.远程主机将公钥发给用户----远程主机收到用户的登录请求，把自己的公钥发给客户端,客户端检查这个public key是否在自己的$HOME/.ssh/known_hosts中，如果没有，客户端会提示是否要把这个public key加入到known_hosts中.
  2.用户使用公钥加密密码------用户使用这个公钥，将登录密码加密后，发送回来
  3.远程主机使用私钥加密------远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录。
  4.客户端把PUBLIC KEY(client), 发送给服务器。
  5.至此，到此为止双方彼此拥有了对方的公钥，开始双向加密解密。
```

PS：当网络中有另一台冒牌服务器冒充远程主机时，客户端的连接请求被服务器B拦截，服务器B将自己的公钥发送给客户端，客户端就会将密码加密后发送给冒牌服务器，冒牌服务器就可以拿自己的私钥获取到密码，然后为所欲为。因此当第一次链接远程主机时，在上述步骤中，会提示您当前远程主机的”公钥指纹”，以确认远程主机是否是正版的远程主机，如果选择继续后就可以输入密码进行登录了，当远程的主机接受以后，该台服务器的公钥就会保存到 ~/.ssh/known_hosts文件中。

### 基于密匙的安全验证通讯原理：

这种方式你需要在当前用户家目录下为自己创建一对密匙，并把公匙放在需要登录的服务器上。当你要连接到服务器上时，客户端就会向服务器请求使用密匙进行安全验证。服务器收到请求之后，会在该服务器上你所请求登录的用户的家目录下寻找你的公匙，然后与你发送过来的公匙进行比较。如果两个密匙一致，服务器就用该公匙加密“质询”并把它发送给客户端。客户端收到“质询”之后用自己的私匙解密再把它发送给服务器。与第一种级别相比，第二种级别不需要在网络上传送口令。

PS：简单来说，就是将客户端的公钥放到服务器上，那么客户端就可以免密码登录服务器了，那么客户端的公钥应该放到服务器上哪个地方呢？默认为你要登录的用户的家目录下的 .ssh 目录下的 authorized_keys 文件中（即：~/.ssh/authorized_keys）。
我们的目标是: 用户已经在主机A上登录为a用户，现在需要以不输入密码的方式以用户b登录到主机B上。   

可以把密钥理解成一把钥匙, 公钥理解成这把钥匙对应的锁头,
把锁头(公钥)放到想要控制的server上, 锁住server, 只有拥有钥匙(密钥)的人,
才能打开锁头, 进入server并控制
而对于拥有这把钥匙的人, 必需得知道钥匙本身的密码,才能使用这把钥匙(除非这把钥匙没设置密码), 这样就可以防止钥匙被了配了(私钥被人复制)
 
当然, 这种例子只是方便理解罢了,
拥有root密码的人当然是不会被锁住的, 而且不一定只有一把锁(公钥),
但如果任何一把锁, 被人用其对应的钥匙(私钥)打开了, server就可以被那个人控制了
所以说, 只要你曾经知道server的root密码, 并将有root身份的公钥放到上面,
就可以用这个公钥对应的私钥"打开" server, 再以root的身分登录,即使现在root密码已经更改!

步骤如下：

  1. 以用户a登录到主机A上，生成一对公私钥。
  2. 把主机A的公钥复制到主机B的authorized_keys中，可能需要输入b@B的密码。

	    ssh-copy-id -i ~/.ssh/id_dsa.pub b@B
  3. 在a@A上以免密码方式登录到b@B

  		ssh b@B

tips:

   假如B机器修改端口后，将主机A上的公钥复制到B机的操作方法是(下面方法中双引号是必须的)：

   ssh-copy-id "-p 端口号 b@B"

### SSH forwarding:

SSH 端口转发自然需要 SSH 连接，而 SSH 连接是有方向的，从 SSH Client 到 SSH Server 。
而我们所要访问的应用也是有方向的，应用连接的方向也是从应用的 Client端连接到应用的 Server端。
比如需要我们要访问Internet上的Web站点时，Http应用的方向就是从我们自己这台主机(Client)到远处的Web Server。

如果SSH连接和应用的连接这两个连接的方向一致，那我们就说它是本地转发。

本地转发Local Forward
```
ssh -L <local port>:<remote host>:<remote port> <SSH hostname>
```
ssh  -L 1433:target_server:1433 user@ssh_host

**xshell**

```
(1)ssh远程连接到Linux
(2)打开代理设置面板，点击:view -> Tunneling Pane,在弹出的窗口选择Forwarding Rules
(3)在空白处右键：add。
在弹出的Forwarding Rule，
Type选择"Local(Outgoing)";
Source Host使用默认的localhost; Listen Port添上端口8888;
Destination Host使用默认的localhost；Destination Port添上80;

Destination Host设置为localhost为要访问的机器，可以设置为登陆后的机器可以访问到的IP
```

如果SSH连接和应用的连接这两个连接的方向不同，那我们就说它是远程转发。
```
ssh -R <local port>:<remote host>:<remote port> <SSH hostname>
```


### windows ---xshell

  * 私钥,在Xshell里也叫用户密钥
  * 公钥,在Xshell里也叫主机密钥
   利用xshell密钥管理服务器远程登录,
   (1)Xshell自带有用户密钥生成向导,:点击菜单栏的工具->新建用户密钥生成向导 
   (2)添加公钥(Pubic Key)到远程Linux服务器
